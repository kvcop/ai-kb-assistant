# Telegram ‚Üî Codex bridge + Watcher (standalone module)

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –¥–æ–±–∞–≤–ª—è–µ—Ç ¬´–≤—Ç–æ—Ä–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å¬ª –∫ Codex —á–µ—Ä–µ–∑ Telegram –∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π watcher –ø–æ —Ç–∞–π–º–µ—Ä—É.

–ß—Ç–æ —É–º–µ–µ—Ç:

- **Bot interface**: –≤–∞—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ `codex exec ...`, –∞ –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ –≤ Telegram.
- **–£–º–Ω—ã–π —Ä–æ—É—Ç–µ—Ä –ø–æ –ø—Ä–∞–≤–∞–º**: –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º —Ä–æ—É—Ç–µ—Ä –¥–µ–ª–∞–µ—Ç *read-only* –∑–∞–ø—É—Å–∫ Codex, –ø—Ä–æ—Å–∏—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –≤ —Å—Ç—Ä–æ–≥–æ–º JSON (`read` vs `write`), –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
- **Watcher**: –ø–æ —Ç–∞–π–º–µ—Ä—É –ø—Ä–æ–≤–µ—Ä—è–µ—Ç ¬´—Ç–∏—à–∏–Ω—É¬ª (–Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ KB/—Å—Ç–∞—Ç—É—Å–∞—Ö + –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Telegram) –∏ —à–ª—ë—Ç –º—è–≥–∫–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è **–ø–æ —Å—Ç–∞–¥–∏—è–º**.
- **Inline buttons**: –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ /help –ø—Ä–∏—Ö–æ–¥—è—Ç —Å –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∞–º–∏, —á—Ç–æ–±—ã –æ—Ç–≤–µ—á–∞—Ç—å –≤ 1 —Ç–∞–ø.
- **Skills-ready**: —Å–æ–æ–±—â–µ–Ω–∏—è –≤—Ä–æ–¥–µ ¬´–¥–∞–≤–∞–π –∑–∞–∫–æ–Ω—á–∏–º –¥–µ–Ω—å¬ª –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ automation-–ø—Ä–æ—Ñ–∏–ª—å, —á—Ç–æ–±—ã Codex/skills –∑–∞–ø—É—Å–∫–∞–ª–∏ –ø–∞–π–ø–ª–∞–π–Ω—ã.

–í–∞–∂–Ω–æ:

- –ú–æ–¥—É–ª—å —Å–∞–º –ø–æ —Å–µ–±–µ –Ω–∏—á–µ–≥–æ –Ω–µ ¬´–≤–µ–¥—ë—Ç¬ª –≤ KB –∏ –Ω–µ –ø—Ä–∞–≤–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–∫—Ä–∏–ø—Ç—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.
- –ò–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –≤–æ–∑–º–æ–∂–Ω—ã **—Ç–æ–ª—å–∫–æ** –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º `write` (–∏–ª–∏ –≤—ã —è–≤–Ω–æ –≤–∫–ª—é—á–∏–ª–∏ dangerous override).
- –í –≥—Ä—É–ø–ø–∞—Ö/—Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–∞—Ö Telegram –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–∞–µ—Ç Privacy Mode: –±–æ—Ç –æ–±—ã—á–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∫–æ–º–∞–Ω–¥—ã (`/‚Ä¶@BotName`) –∏ reply –Ω–∞ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è. –î–ª—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π `/ask@BotName <—Ç–µ–∫—Å—Ç>` –∏–ª–∏ reply (—É–ø–æ–º–∏–Ω–∞–Ω–∏—è `@BotName ‚Ä¶` —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–∫–ª—é—á–∏—Ç—å privacy mode/—Å–¥–µ–ª–∞—Ç—å –±–æ—Ç–∞ admin).

## –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è (–µ—Å–ª–∏ —Å—Ç–∞–≤–∏—à—å –º–Ω–æ–≥–æ –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥—å)

- –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π/–∫–æ–º–∞–Ω–¥ –ø–æ–¥—Ä—è–¥: –±–æ—Ç –ø–æ—Å—Ç–∞–≤–∏—Ç –∏—Ö –≤ –æ—á–µ—Ä–µ–¥—å –∏ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å **–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ø–æ —Ä–∞–∑–Ω—ã–º scope** (`chat_id + message_thread_id`) –¥–æ –ª–∏–º–∏—Ç–∞ `TG_MAX_PARALLEL_JOBS` (–≤ –æ–¥–Ω–æ–º scope –≤—Å–µ–≥–¥–∞ `<=1` –∑–∞–¥–∞—á–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ).
- –°—Ä–∞–∑—É –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫–æ—Ä–æ—Ç–∫–∏–π ack (‚Äú‚úÖ –ü—Ä–∏–Ω—è–ª‚Ä¶‚Äù, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Å –ø–æ–∑–∏—Ü–∏–µ–π –≤ –æ—á–µ—Ä–µ–¥–∏). –ö–æ–≥–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ –≤–∑—è—Ç–æ –≤ —Ä–∞–±–æ—Ç—É ‚Äî –±–æ—Ç **—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —ç—Ç–æ—Ç ack** –∏ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å –µ–≥–æ –ø–æ —Ç–∞–π–º–µ—Ä—É; –ø–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç —Ç–æ–∂–µ –≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Ç—É–¥–∞ –∂–µ. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –¥–ª—è –æ–¥–Ω–æ–≥–æ edit ‚Äî –æ–Ω –ø—Ä–∏–¥—ë—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏, –∞ ack –æ–±–Ω–æ–≤–∏—Ç—Å—è –Ω–∞ ‚Äú‚úÖ –ì–æ—Ç–æ–≤–æ. –û—Ç–≤–µ—Ç –Ω–∏–∂–µ.‚Äù. –ï—Å–ª–∏ ack –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å/–ø–æ–ª—É—á–∏—Ç—å `message_id` (–Ω–∞–ø—Ä–∏–º–µ—Ä, Telegram –±—ã–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏ —Å—Ä–∞–±–æ—Ç–∞–ª outbox) ‚Äî –±—É–¥–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–µ progress‚Äë—Å–æ–æ–±—â–µ–Ω–∏–µ.
- –í –ø—Ä–æ–º–ø—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è **–≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏** —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram (Telegram `date`), –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏ –æ—á–µ—Ä–µ–¥–∏ –Ω–µ –ø—É—Ç–∞–µ—Ç—Å—è ‚Äú–∫–æ–≥–¥–∞ –Ω–∞–ø–∏—Å–∞–ª‚Äù –∏ ‚Äú–∫–æ–≥–¥–∞ –æ–±—Ä–∞–±–æ—Ç–∞–ª–æ—Å—å‚Äù.
- –î–ª—è —Ç–∏—à–∏–Ω—ã (–µ—Å–ª–∏ —Ç—ã –ø—Ä–æ—Å—Ç–æ –∏–Ω–æ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—à—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç): `/mute ‚Ä¶`, `/lunch`, –∏–ª–∏ `/gentle`.

## –û—á–µ—Ä–µ–¥—å: —Å–æ–æ–±—â–µ–Ω–∏—è / –∫–æ–º–∞–Ω–¥—ã / –∫–Ω–æ–ø–∫–∏

- –í –æ—á–µ—Ä–µ–¥—å –ø–æ–ø–∞–¥–∞–µ—Ç –ø–æ—á—Ç–∏ –≤—Å—ë: –æ–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, slash‚Äë–∫–æ–º–∞–Ω–¥—ã (`/‚Ä¶`) –∏ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ inline‚Äë–∫–Ω–æ–ø–∫–∏.
- ‚ÄúControl plane‚Äù (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É, –¥–∞–∂–µ –µ—Å–ª–∏ Codex –∑–∞–Ω—è—Ç): `/start`, `/help`, `/id`, `/whoami`, `/status`, `/reminders`; –≤ owner‚Äë–ª–∏—á–∫–µ —Ç–∞–∫–∂–µ `/queue`, `/drop`, `/stats`, `/doctor`, `/upload`, `/mute`, `/lunch`, `/back`, `/gentle`, `/settings` –∏ –∫–Ω–æ–ø–∫–∏ üóë/üîï/üçΩÔ∏è/‚úÖ/üìå/ü´∂/‚úçÔ∏è.
- `/restart` –∏ `/reset` —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å (—É–≤–∞–∂–∞—é—Ç –ø–æ—Ä—è–¥–æ–∫).
- Scheduler: –≤—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–¥–∞—á–∏ **–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ** –≤ —Ä–∞–∑–Ω—ã—Ö scope (—Å–º. `TG_MAX_PARALLEL_JOBS`); –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ scope ‚Äî —Å—Ç—Ä–æ–≥–æ –ø–æ –æ—á–µ—Ä–µ–¥–∏.
- Codex‚Äë—Å–µ—Å—Å–∏–∏ —Ä–∞–∑–¥–µ–ª—è—é—Ç—Å—è –ø–æ scope: `session_key = chat_id` –∏–ª–∏ `chat_id:message_thread_id` (–¥–ª—è topics/threads), —á—Ç–æ–±—ã `resume` –Ω–µ —Å–º–µ—à–∏–≤–∞–ª –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã.
- –î–ª—è –∫–∞–∂–¥–æ–π Telegram‚Äëchat –±–æ—Ç –∫—ç—à–∏—Ä—É–µ—Ç `Codex session_id` (UUID) –≤ `logs/tg-bot/codex-resume-cache.json`: –µ—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –µ—â—ë –Ω–µ—Ç ‚Äî –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –∏–¥—ë—Ç –±–µ–∑ `resume`, –∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ id —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.
- –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç –±–µ—Ä—ë—Ç —Ñ–∞–π–ª–æ–≤—ã–π lock —Ä—è–¥–æ–º —Å–æ state‚Äë—Ñ–∞–π–ª–æ–º (`state.json.lock`), —á—Ç–æ–±—ã —Å–ª—É—á–∞–π–Ω–æ –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–≤–µ –∫–æ–ø–∏–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ. –û—Ç–∫–ª—é—á–∏—Ç—å –º–æ–∂–Ω–æ `TG_SINGLE_INSTANCE=0`.

### /restart (graceful + —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –¥–∏—Å–∫)

- –ü–µ—Ä–≤—ã–π `/restart` ‚Äú–≤–æ–æ—Ä—É–∂–∞–µ—Ç‚Äù —Ä–µ—Å—Ç–∞—Ä—Ç (`restart_pending=true`): –±–æ—Ç –¥–æ–∂–¥—ë—Ç—Å—è, –ø–æ–∫–∞ –æ—á–µ—Ä–µ–¥—å –æ–ø—É—Å—Ç–µ–µ—Ç, –∏ –∑–∞–≤–µ—Ä—à–∏—Ç –ø—Ä–æ—Ü–µ—Å—Å (systemd —Å `Restart=always` –ø–æ–¥–Ω–∏–º–µ—Ç —Å–Ω–æ–≤–∞).
- –í–∞–∂–Ω–æ: –µ—Å–ª–∏ –≤ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –≤ –¥—Ä—É–≥–∏—Ö scope, —Ä–µ—Å—Ç–∞—Ä—Ç –ø—Ä–µ—Ä–≤—ë—Ç –∏—Ö. –ü–µ—Ä–µ–¥ `/restart` –ø–æ–ª–µ–∑–Ω–æ –≥–ª—è–Ω—É—Ç—å `/queue` (—Å–∫–æ–ª—å–∫–æ ‚Äú–í —Ä–∞–±–æ—Ç–µ‚Äù) –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–∂–¥–∞—Ç—å—Å—è idle.
- –ü–æ–∫–∞ `restart_pending=true`:
  - –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∫–æ–º–∞–Ω–¥—ã **–Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è**: –±–æ—Ç –ø–∏—à–µ—Ç –∏—Ö –≤ `logs/tg-bot/queue.jsonl` –∏ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞;
  - –ø–æ–≤—Ç–æ—Ä–Ω—ã–π `/restart` —Ç–æ–∂–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ `queue.jsonl` –∏ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞ (–º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å —Ü–µ–ø–æ—á–∫—É; –∫–∞–∂–¥–æ–µ `/restart` = –±–∞—Ä—å–µ—Ä);
  - inline‚Äë–∫–Ω–æ–ø–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø—É—Å–∫–∞—é—Ç Codex, –≤—Ä–µ–º–µ–Ω–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è (Telegram‚Äë–æ—Ç–≤–µ—Ç ‚ÄúüîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é—Å—å‚Äù), –ø–æ—Ç–æ–º—É —á—Ç–æ callback‚Äë—Å–æ–±—ã—Ç–∏—è –Ω–µ —Å–ø—É–ª–∏–º –Ω–∞ –¥–∏—Å–∫; ‚Äúcontrol plane‚Äù –∫–Ω–æ–ø–∫–∏ (üóë/üîï/üçΩÔ∏è/‚úÖ/üìå/ü´∂/‚úçÔ∏è) –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.
- –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å –∏–∑ `queue.jsonl` (–∏ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è `queue.jsonl.drain.*.jsonl` –ø–æ—Å–ª–µ –∞–≤–∞—Ä–∏–π–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞), –Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–æ –ø–µ—Ä–≤–æ–≥–æ `/restart` –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ.

### /reset (—Å–±—Ä–æ—Å telegram‚ÄëCodex —Å–µ—Å—Å–∏–π)

- `/reset` –æ—á–∏—â–∞–µ—Ç `CODEX_HOME` –ø—Ä–æ—Ñ–∏–ª–µ–π (chat/auto/router/danger) –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç `logs/tg-bot/codex-resume-cache.json`.
- –≠—Ç–æ **–ª–æ–∫–∞–ª—å–Ω–∞—è** –∫–æ–º–∞–Ω–¥–∞: –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç Codex –∏ –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.
- `/reset` —Ç–æ–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å: –µ—Å–ª–∏ –∞–≥–µ–Ω—Ç –∑–∞–Ω—è—Ç ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –ø–æ–∑–∂–µ; –µ—Å–ª–∏ —É–∂–µ –∏–¥—ë—Ç —Ä–µ—Å—Ç–∞—Ä—Ç ‚Äî –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ `queue.jsonl` –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞.

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Ä–µ–∂–∏–º—ã (read/write/‚àÜ)

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ ‚Äú–±–µ–∑–æ–ø–∞—Å–Ω–æ–π‚Äù —Å—Ö–µ–º–µ:

1) **–†–æ—É—Ç–µ—Ä** –∑–∞–ø—É—Å–∫–∞–µ—Ç Codex –≤ `read-only` –∏ –ø—Ä–æ—Å–∏—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∫–∞–∫ `read`/`write`.
2) –ë–æ—Ç –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π `codex exec ...` (—Å per-scope resume).

–ß—Ç–æ–±—ã –Ω–µ –¥–µ—Ä–∂–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ —Ç—è–∂—ë–ª—ã–π —Ä–µ–∂–∏–º reasoning, –±–æ—Ç –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—É—Å–∫ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç `model_reasoning_effort` —á–µ—Ä–µ–∑ `codex ... -c model_reasoning_effort=...` (–±–µ–∑ –ø—Ä–∞–≤–æ–∫ `~/.codex/config.toml` –∏ –±–µ–∑ –ª–æ–º–∞–Ω–∏—è `resume`):

- –†–æ—É—Ç–µ—Ä‚Äë–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è: `low`
- –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—É—Å–∫: `low`/`medium` –¥–ª—è read (–ø–æ `complexity`), `xhigh` –¥–ª—è write/dangerous –∏ –¥–ª—è `complexity=high`
- –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–æ–≤–æ `fastthink` (–≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ) ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—É—Å–∫ —Ñ–æ—Ä—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ `low` (–º–∞—Ä–∫–µ—Ä –≤—ã—Ä–µ–∑–∞–µ—Ç—Å—è –∏–∑ –ø—Ä–æ–º–ø—Ç–∞; `ultrathink` –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ).
- –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–æ–≤–æ `ultrathink` (–≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ) ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—É—Å–∫ —Ñ–æ—Ä—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ `xhigh` (–º–∞—Ä–∫–µ—Ä –≤—ã—Ä–µ–∑–∞–µ—Ç—Å—è –∏–∑ –ø—Ä–æ–º–ø—Ç–∞).

–ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É —Ä–æ—É—Ç–µ—Ä–∞:

- `read`  ‚Üí chat‚Äë–ø—Ä–æ—Ñ–∏–ª—å (`--sandbox $CODEX_CHAT_SANDBOX`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `read-only`)
- `write` ‚Üí automation‚Äë–ø—Ä–æ—Ñ–∏–ª—å (`--full-auto`, –µ—Å–ª–∏ `CODEX_AUTO_FULL_AUTO=1`)

–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å (floor):

- `ROUTER_MIN_PROFILE` / `TG_MIN_PROFILE` (default: `read`) ‚Äî `read` | `write` | `danger`
  - `write`: chat‚Äë–ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è; —Ä–æ—É—Ç–µ—Ä read/write –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä, —Å—Ä–∞–∑—É –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤ write
  - `danger`: –≤—Å–µ–≥–¥–∞ dangerous override (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –±–µ–∑ —Ä–æ—É—Ç–µ—Ä–∞)

–ü—Ä–µ—Ñ–∏–∫—Å—ã (—Ñ–æ—Ä—Å–∏—Ä–æ–≤–∞–Ω–∏–µ):

- `!` (–∏–ª–∏ `ROUTER_FORCE_WRITE_PREFIX`) ‚Äî –≤—Å–µ–≥–¥–∞ `write`
- `?` (–∏–ª–∏ `ROUTER_FORCE_READ_PREFIX`) ‚Äî –≤—Å–µ–≥–¥–∞ `read`
- `‚àÜ` (–∏–ª–∏ `ROUTER_FORCE_DANGEROUS_PREFIX`) ‚Äî **DANGEROUS**: –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ä–æ—É—Ç–µ—Ä –∏ —Å—Ä–∞–∑—É –∑–∞–ø—É—Å–∫–∞–µ—Ç Codex —Å `--dangerously-bypass-approvals-and-sandbox --sandbox danger-full-access`

–ü–æ—á–µ–º—É dangerous –∏–Ω–æ–≥–¥–∞ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:

- Dangerous override –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è ‚Äú–º–æ–ª—á–∞‚Äù: –ª–∏–±–æ —è–≤–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å `‚àÜ`, –ª–∏–±–æ –∫–Ω–æ–ø–∫–∞ **–î–∞** –≤ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏.
- –†–æ—É—Ç–µ—Ä —É–º–µ–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—á—Ç–∏ –Ω–∞–≤–µ—Ä–Ω—è–∫–∞ —Ç—Ä–µ–±—É—é—Ç dangerous override (–Ω–∞–ø—Ä–∏–º–µ—Ä: `git push/pull/clone`, ‚Äú–∑–∞–ø—É—à—å‚Äù, ‚Äú–Ω–∞–π–¥–∏ –≤ —Å–µ—Ç–∏/–∑–∞–≥—É–≥–ª–∏‚Äù, —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–æ–≤) –∏ **–¥–æ –∑–∞–ø—É—Å–∫–∞ Codex** –ø–æ–∫–∞–∂–µ—Ç –∫–Ω–æ–ø–∫–∏ **–î–∞/–ù–µ—Ç**.
  - **–î–∞** ‚Üí –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤ dangerous‚Äë–ø—Ä–æ—Ñ–∏–ª–µ (`--dangerously-bypass-approvals-and-sandbox`).
  - **–ù–µ—Ç** ‚Üí –Ω–µ –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å dangerous.
  - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ (–∫–Ω–æ–ø–∫–∏ —Å–Ω–∏–º–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è); TTL –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ~30 –º–∏–Ω—É—Ç.
- –ü–æ–∫–∞ –≤–∏—Å–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ **–î–∞/–ù–µ—Ç**, –∑–∞–ø—Ä–æ—Å –≤ —ç—Ç–æ–º scope ‚Äú–∑–∞–º–æ—Ä–æ–∂–µ–Ω‚Äù, –Ω–æ –±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ scope (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è).
  - –ù–∞–∂–∞—Ç–∏–µ **–î–∞/–ù–µ—Ç** –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º, —á—Ç–æ–±—ã –Ω–µ –∂–¥–∞—Ç—å –Ω–∞–∫–æ–ø–∏–≤—à–∏—Ö—Å—è —Å–æ–æ–±—â–µ–Ω–∏–π.
- –°–∏–º–≤–æ–ª –ø—Ä–µ—Ñ–∏–∫—Å–∞ –º–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å —á–µ—Ä–µ–∑ `ROUTER_FORCE_DANGEROUS_PREFIX` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `‚àÜ`).

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ **–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ** –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–æ–±—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å UX), –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –≤ dangerous —Å —Ö–≤–æ—Å—Ç–æ–≤—ã–º control‚Äë–±–ª–æ–∫–æ–º (fenced –∏–ª–∏ raw JSON):
```tg_bot
{"dangerous_confirm": true}
```

–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: TTL –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –≤ control‚Äë–±–ª–æ–∫–µ (–º–æ–∂–Ω–æ –≤–º–µ—Å—Ç–µ —Å `dangerous_confirm`):
```text
{"dangerous_confirm_ttl_seconds": 600}
```

- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Ä–æ—É—Ç–µ—Ä—É **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –≤–∫–ª—é—á–∞—Ç—å dangerous, –≤—ã—Å—Ç–∞–≤–∏ `ROUTER_DANGEROUS_AUTO=1` (–∏–ª–∏ `TG_DANGEROUS_AUTO=1`).

## –ß—Ç–æ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –ø—Ä–æ–º–ø—Ç (–∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ Telegram)

- –ë–ª–æ–∫ `TELEGRAM_BOT_CONTEXT` —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏, —Ñ–ª–∞–≥–∞–º–∏ (gentle/snooze) –∏ –≤—Ä–µ–º–µ–Ω–µ–º —Å–æ–±—ã—Ç–∏–π.
- –î–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è **–≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏** (Telegram `date`), —á—Ç–æ–±—ã –ø—Ä–∏ –æ—á–µ—Ä–µ–¥–∏ –Ω–µ –ø—É—Ç–∞—Ç—å ‚Äú–∫–æ–≥–¥–∞ –Ω–∞–ø–∏—Å–∞–ª‚Äù –∏ ‚Äú–∫–æ–≥–¥–∞ –æ–±—Ä–∞–±–æ—Ç–∞–ª–æ—Å—å‚Äù.
- Reply: –µ—Å–ª–∏ —Ç—ã –æ—Ç–≤–µ—á–∞–µ—à—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ (reply_to_message), –±–æ—Ç –¥–æ–±–∞–≤–∏—Ç –µ–≥–æ –∞–≤—Ç–æ—Ä–∞/–≤—Ä–µ–º—è/—Ç–µ–∫—Å—Ç (–∏, –µ—Å–ª–∏ –±—ã–ª–∏, –≤–ª–æ–∂–µ–Ω–∏—è).
- Quote: –µ—Å–ª–∏ Telegram –ø—Ä–∏—Å–ª–∞–ª –≤—ã–¥–µ–ª–µ–Ω–Ω—É—é —Ü–∏—Ç–∞—Ç—É, –æ–Ω–∞ –ø–æ–ø–∞–¥—ë—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–º –±–ª–æ–∫–æ–º.
- –í–ª–æ–∂–µ–Ω–∏—è: –±–æ—Ç —Å–∫–∞—á–∏–≤–∞–µ—Ç —Ñ–∞–π–ª—ã –Ω–∞ –¥–∏—Å–∫ –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—É—Ç–∏ –≤ –ø—Ä–æ–º–ø—Ç (—Å–º. –Ω–∏–∂–µ).

## –§–∞–π–ª—ã (attachments)

- –ë–æ—Ç —Å–∫–∞—á–∏–≤–∞–µ—Ç –≤–ª–æ–∂–µ–Ω–∏—è –∏–∑ Telegram (documents/photos/video/audio/voice) –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Ö –Ω–∞ –¥–∏—Å–∫ –≤ `tg_uploads/<chat_id>/...` (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `TG_UPLOADS_DIR`).
- **Voice** (–≥–æ–ª–æ—Å–æ–≤—ã–µ) ‚Äî –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é **–Ω–µ –∞–≤—Ç–æ‚Äë—Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è** (—á—Ç–æ–±—ã –Ω–µ —Ç—Ä–µ–±–æ–≤–∞—Ç—å `speech2text` ‚Äú–∏–∑ –∫–æ—Ä–æ–±–∫–∏‚Äù). –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ‚Äë—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ: `TG_VOICE_AUTO_TRANSCRIBE=1`. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø–æ–∫–∞–∑–∞—Ç—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É `TG_VOICE_ECHO_TRANSCRIPT=1`; –≤—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ‚Äë–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ –≥–ª–æ—Å—Å–∞—Ä–∏—é `notes/work/typos.md`: `TG_VOICE_APPLY_TYPO_GLOSSARY=0`. –î–ª—è –∞–≤—Ç–æ‚Äë—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–∫–µ–Ω `speech2text` (—Å–º. `python3 scripts/speech2text.py login ...` –∏–ª–∏ `SPEECH2TEXT_TOKEN=...`); base URL –±–µ—Ä—ë—Ç—Å—è –∏–∑ `SPEECH2TEXT_BASE_URL` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `http://127.0.0.1:8000/api`).
- –ï—Å–ª–∏ —Ñ–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω **–±–µ–∑ –ø–æ–¥–ø–∏—Å–∏** (caption) ‚Äî –±–æ—Ç –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è: –∫–æ–ø–∏—Ç —Ñ–∞–π–ª—ã –∏ –∂–¥—ë—Ç —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç; —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Codex **–≤–º–µ—Å—Ç–µ —Å–æ —Å–ø–∏—Å–∫–æ–º –ø—É—Ç–µ–π** –∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º —Ñ–∞–π–ª–∞–º.
- –ï—Å–ª–∏ –ø–æ–¥—Ä—è–¥ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏ ‚Äî –æ–Ω–∏ –≤—Å–µ –Ω–∞–∫–æ–ø—è—Ç—Å—è; —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç ‚Äú–ø–æ–¥—Ü–µ–ø–∏—Ç—Å—è‚Äù –∫–æ –≤—Å–µ–º –æ–∂–∏–¥–∞—é—â–∏–º —Ñ–∞–π–ª–∞–º.
- –õ–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: `TG_UPLOAD_MAX_MB` (default: `50`; `0` = –±–µ–∑ –ª–∏–º–∏—Ç–∞).

## –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å —Å–µ—Ç–∏ (VPN/DNS)

- –ï—Å–ª–∏ Telegram –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (VPN/DNS), –∏—Å—Ö–æ–¥—è—â–∏–µ `send_message`/`edit_message_*` —Å–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –≤ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π outbox (`logs/tg-bot/state.json`) –∏ —Ä–µ—Ç—Ä–∞—è—Ç—Å—è —Å backoff: `2/4/8‚Ä¶` –¥–æ `5 –º–∏–Ω—É—Ç`, –¥–∞–ª—å—à–µ ‚Äî —Ä–∞–∑ –≤ `5 –º–∏–Ω—É—Ç` –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ.
- –ï—Å–ª–∏ `codex exec` –ø–∞–¥–∞–µ—Ç –∏–∑‚Äë–∑–∞ —Å–µ—Ç–∏, –±–æ—Ç –º–æ–∂–µ—Ç –æ—Ç–ª–æ–∂–∏—Ç—å –∑–∞–¥–∞—á—É –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (best‚Äëeffort probe `TG_CODEX_PROBE_HOST/TG_CODEX_PROBE_PORT`).

–§–∞–π–ª—ã –ª–æ–≥–æ–≤ (–¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏):

- `logs/tg-bot/state.json` ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ (offset, mute/gentle, outbox, pending jobs)
- `logs/tg-bot/queue.jsonl` ‚Äî —Å–ø—É–ª –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ —Ä–µ—Å—Ç–∞—Ä—Ç
- `logs/tg-bot/net.log` ‚Äî —Å–µ—Ç–µ–≤—ã–µ —Ä–µ—Ç—Ä–∞–∏ Telegram
- `logs/tg-bot/codex.log` ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º—ã–µ –∫–æ–º–∞–Ω–¥—ã Codex –∏ –æ—à–∏–±–∫–∏
- `logs/tg-bot/messages.log` ‚Äî –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–∫—Ä–∞—Ç–∫–∏–π JSONL preview)
- `logs/tg-bot/callbacks.log` ‚Äî –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–æ–∫/–∫–æ–ª–ª–±—ç–∫–∏ (JSONL)
- `logs/tg-bot/topics/<chat_id>/<message_thread_id>/events.jsonl` ‚Äî –∏—Å—Ç–æ—Ä–∏—è –ø–æ —Ç–æ–ø–∏–∫–∞–º (–≤—Ö–æ–¥—è—â–µ–µ + ‚Äú—Å–º—ã—Å–ª–æ–≤—ã–µ‚Äù –∏—Å—Ö–æ–¥—è—â–∏–µ; –≤–∫–ª—é—á–∏—Ç—å –≤—Å—ë: `TG_TOPIC_LOG_MODE=all`)

## –ö—É–¥–∞ –ø–æ–ª–æ–∂–∏—Ç—å

–†–∞—Å–ø–∞–∫—É–π—Ç–µ –ø–∞–ø–∫—É `tg_bot/` –≤ **–∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è**, —Ä—è–¥–æ–º —Å `scripts/`, `notes/`, `configs/`.

–ü—Ä–∏–º–µ—Ä:
```
repo/
  scripts/
  notes/
  configs/
  tg_bot/
```

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1) –°–æ–∑–¥–∞–π—Ç–µ Telegram-–±–æ—Ç–∞ –≤ @BotFather –∏ –ø–æ–ª—É—á–∏—Ç–µ `TG_BOT_TOKEN`.

2) –°–æ–∑–¥–∞–π—Ç–µ `.env` –¥–ª—è –±–æ—Ç–∞ (–ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç—Å—è `tg_bot/.env` –∏–ª–∏ `.env.tg_bot` –≤ –∫–æ—Ä–Ω–µ):

```bash
TG_BOT_TOKEN="123456:ABCDEF..."
TG_OWNER_CHAT_ID="123456789"      # chat_id owner-—á–∞—Ç–∞ (–æ–±—ã—á–Ω–æ = –≤–∞—à user_id; –º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å —á–µ—Ä–µ–∑ /id)
TG_ALLOWED_CHAT_IDS="-100123..."  # (optional) group chat ids (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
TG_ALLOWED_USER_IDS="123456789"   # (optional) user ids –¥–ª—è –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
```

3) –ó–∞–ø—É—Å–∫ –∏–∑ –∫–æ—Ä–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:

```bash
python3 -m tg_bot
```

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–æ—Å–Ω–æ–≤–Ω—ã–µ)

### Telegram
- `TG_BOT_TOKEN` (required)
- `TG_ALLOWED_USER_IDS` ‚Äî —Å–ø–∏—Å–æ–∫ user_id —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è; –º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å —á–µ—Ä–µ–∑ `/id`)
- `TG_ALLOWED_CHAT_IDS` ‚Äî —Å–ø–∏—Å–æ–∫ chat_id —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)
- `TG_OWNER_CHAT_ID` ‚Äî –µ—Å–ª–∏ –∑–∞–¥–∞–Ω, –≤–∫–ª—é—á–∞–µ—Ç multi-tenant —Ä–µ–∂–∏–º:
  - owner-—á–∞—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å **–æ—Å–Ω–æ–≤–Ω–æ–π** KB (repo root)
  - –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —á–∞—Ç—ã (–ª–∏—á–Ω—ã–µ –∏ –≥—Ä—É–ø–ø–æ–≤—ã–µ) –ø–æ–ª—É—á–∞—é—Ç **–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π** workspace –±–µ–∑ –≤–∞—à–µ–π –ª–∏—á–Ω–æ–π –∏–Ω—Ñ—ã/Jira
  - watcher/—â–∞–¥—è—â–∏–π —Ä–µ–∂–∏–º –∏ –≤—Å–µ ‚Äú–∫–Ω–æ–ø–∫–∏ –º—å—é—Ç–∞‚Äù –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ owner-—á–∞—Ç—É (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —É—Ç–µ—á–µ–∫/—Å–ø–∞–º–∞ –≤ –≥—Ä—É–ø–ø—ã)
  - –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–æ–∂–µ —É—Ö–æ–¥—è—Ç —Ç–æ–ª—å–∫–æ –≤ owner-—á–∞—Ç, –Ω–æ –∏—Ö –º–æ–∂–Ω–æ **—è–≤–Ω–æ** –∞–¥—Ä–µ—Å–æ–≤–∞—Ç—å –≤ –≥—Ä—É–ø–ø—ã/—á–∞—Ç—ã —á–µ—Ä–µ–∑ `|to=...` (—Å–º. `WATCH_REMINDER_BROADCAST_CHAT_IDS`)
- `TG_WORKSPACES_DIR` (default: `logs/tg-bot/workspaces`) ‚Äî –∫—É–¥–∞ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ KB –¥–ª—è non-owner —á–∞—Ç–æ–≤
- `TG_POLL_TIMEOUT_SECONDS` (default: 25)
- `TG_MAX_PARALLEL_JOBS` (default: `5`) ‚Äî –º–∞–∫—Å–∏–º—É–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á (–≤ —Ä–∞–∑–Ω—ã—Ö scope); –≤ –æ–¥–Ω–æ–º `message_thread_id` –≤—Å–µ–≥–¥–∞ `<=1` inflight
- `TG_ACK_ENABLED` (default: `1`) ‚Äî –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –±—ã—Å—Ç—Ä—ã–π ¬´–ø—Ä–∏–Ω—è–ª¬ª –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–æ –∑–∞–ø—É—Å–∫–∞ Codex)
- `TG_ACK_INCLUDE_QUEUE` (default: `1`) ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é –≤ –æ—á–µ—Ä–µ–¥–∏ –≤ ack‚Äë—Å–æ–æ–±—â–µ–Ω–∏–∏
- `TG_TYPING_ENABLED` (default: `1`) ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç `typing‚Ä¶` –ø–æ–∫–∞ –∏–¥—ë—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞/–∑–∞–ø—É—Å–∫ Codex
- `TG_TYPING_INTERVAL_SECONDS` (default: `4`) ‚Äî –∫–∞–∫ —á–∞—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è—Ç—å `typing‚Ä¶`
- `TG_PROGRESS_EDIT_ENABLED` (default: `1`) ‚Äî –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç progress‚Äë—Å–æ–æ–±—â–µ–Ω–∏–µ (—Ç–∞–π–º–µ—Ä/—Å—Ç–∞—Ç—É—Å), —á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ —á—Ç–æ ¬´–Ω–µ –∑–∞–≤–∏—Å–ª–æ¬ª
- `TG_PROGRESS_EDIT_INTERVAL_SECONDS` (default: `20`) ‚Äî –ø–µ—Ä–∏–æ–¥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- `TG_CODEX_PARSE_MODE` (default: `HTML`) ‚Äî —Ä–µ–Ω–¥–µ—Ä –æ—Ç–≤–µ—Ç–æ–≤ Codex (`HTML` = best‚Äëeffort Markdown‚ÜíHTML: **bold**, `code`, ```code```)
- `TG_CODEX_JSON_PROGRESS` (default: `0`) ‚Äî –≤–∫–ª—é—á–∞–µ—Ç `codex exec --json` –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è/–∫–æ–º–∞–Ω–¥—ã (best‚Äëeffort, –±–µ–∑ —Å–ø–∞–º–∞)
- `TG_CODEX_PROBE_HOST` (default: `chatgpt.com`) ‚Äî —Ö–æ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚Äú—Å–µ—Ç—å –ø–æ–¥–Ω—è–ª–∞—Å—å‚Äù –ø—Ä–∏ –∞–≤—Ç–æ–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏ –∑–∞–¥–∞—á
- `TG_CODEX_PROBE_PORT` (default: `443`)
- `TG_CODEX_PROBE_TIMEOUT_SECONDS` (default: `3`)
- `TG_BOT_API_LOCAL_URL` (default: `http://127.0.0.1:8081`) ‚Äî Local Bot API server (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π `telegram-bot-api`)
- `TG_BOT_API_REMOTE_URL` (default: `https://api.telegram.org`) ‚Äî fallback –Ω–∞ –æ–±–ª–∞—á–Ω—ã–π Bot API
- `TG_BOT_API_PREFER_LOCAL` (default: `0`) ‚Äî –µ—Å–ª–∏ `1`, –±–æ—Ç –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç local Bot API server –∏ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ remote; –µ—Å–ª–∏ `0`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç remote
- `TG_BOT_API_PROBE_SECONDS` (default: `300`) ‚Äî –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –≤—ã–±—Ä–∞–Ω remote, —Ä–∞–∑ –≤ N —Å–µ–∫—É–Ω–¥ –ø—Ä–æ–±—É–µ–º –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ local
- `TG_SINGLE_INSTANCE` (default: `1`) ‚Äî –∑–∞–ø—Ä–µ—â–∞–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –¥–≤–µ –∫–æ–ø–∏–∏ –±–æ—Ç–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (—á–µ—Ä–µ–∑ —Ñ–∞–π–ª–æ–≤—ã–π lock)
- `TG_UPLOADS_DIR` (default: `tg_uploads`) ‚Äî –∫—É–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤–ª–æ–∂–µ–Ω–∏—è –∏–∑ Telegram
- `TG_UPLOAD_MAX_MB` (default: `50`) ‚Äî –ª–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ –≤–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (`0` = –±–µ–∑ –ª–∏–º–∏—Ç–∞)
- `TG_SEND_MAX_MB` (optional; default: `TG_UPLOAD_MAX_MB`) ‚Äî –ª–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞ –¥–ª—è `/upload` (–µ—Å–ª–∏ `0`/–ø—É—Å—Ç–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `50`)

Local Bot API –≤ —Ä–µ–∂–∏–º–µ `--local` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π `file_path` –≤ –æ—Ç–≤–µ—Ç–µ `getFile`; –±–æ—Ç —É–º–µ–µ—Ç —á–∏—Ç–∞—Ç—å —Ç–∞–∫–∏–µ –ø—É—Ç–∏ –Ω–∞–ø—Ä—è–º—É—é.
–ü—Ä–∏–º–µ—Ä systemd user-—Å–µ—Ä–≤–∏—Å–∞ –∏ env-—à–∞–±–ª–æ–Ω: `tg_bot/examples/telegram-bot-api.service`, `tg_bot/examples/telegram-bot-api.env.example`.

### Watcher
- `WATCH_INTERVAL_SECONDS` (default: 180)
- `WATCH_WORK_HOURS` (default: `09:30-19:00`)
- `WATCH_INCLUDE_WEEKENDS` (default: `0`)
- `WATCH_IDLE_MINUTES` (default: `120`) ‚Äî –±–∞–∑–æ–≤—ã–π –ø–æ—Ä–æ–≥ ¬´—Ç–∏—à–∏–Ω—ã¬ª
- `WATCH_ACK_MINUTES` (default: `20`) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∞–¥–∏–π
- `WATCH_IDLE_STAGE_MINUTES` (optional) ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä: `120,140,170,230,320`
- `WATCH_REMINDERS_FILE` (default: `notes/work/reminders.md`)
- `WATCH_REMINDER_GRACE_MINUTES` (default: `90`)
- `WATCH_REMINDERS_INCLUDE_WEEKENDS` (default: `WATCH_INCLUDE_WEEKENDS`) ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å `daily`-–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ (`date`/`range` –Ω–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —ç—Ç–æ–≥–æ —Ñ–ª–∞–≥–∞)
- `WATCH_REMINDER_BROADCAST_CHAT_IDS` (optional) ‚Äî —Å–ø–∏—Å–æ–∫ chat_id (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é) –¥–ª—è `|to=broadcast` (–Ω–∞–ø—Ä–∏–º–µ—Ä: `-100123...`)

–§–æ—Ä–º–∞—Ç `WATCH_REMINDERS_FILE`: `rule<TAB>text` (1 –∑–∞–ø–∏—Å—å –Ω–∞ —Å—Ç—Ä–æ–∫—É). –í `rule` –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—É—Ñ—Ñ–∏–∫—Å `|to=...`:
- `|to=broadcast` ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç—ã –∏–∑ `WATCH_REMINDER_BROADCAST_CHAT_IDS`
- `|to=-100123...,123456` ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ chat_id
- `|to=owner,broadcast` ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å owner‚Äô—É –∏ –≤ broadcast‚Äë—á–∞—Ç—ã

### Mattermost (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —Ç–æ–ø–∏–∫ `/reminders`)

–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å: `pip install mattermostdriver` (–∏–ª–∏ `uv pip install -p .venv/bin/python mattermostdriver`).

- `MM_ENABLED` (default: `0`) ‚Äî –≤–∫–ª—é—á–∏—Ç—å —Ñ–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥
- `MM_URL` (required if enabled) ‚Äî host –∏–ª–∏ –ø–æ–ª–Ω—ã–π URL Mattermost (–Ω–∞–ø—Ä–∏–º–µ—Ä: `mm.example.com` –∏–ª–∏ `https://mm.example.com/mattermost`)
- `MM_AUTH_MODE` (default: `auto`) ‚Äî `auto` | `token` | `login`
- `MM_TOKEN` (optional) ‚Äî Personal Access Token (–µ—Å–ª–∏ `MM_AUTH_MODE=token`)
- `MM_LOGIN_ID` / `MM_PASSWORD` (optional) ‚Äî –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å (–µ—Å–ª–∏ `MM_AUTH_MODE=login`; –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–º MFA –±–æ—Ç –ø–æ–ø—Ä–æ—Å–∏—Ç –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∫–æ–¥ —á–µ—Ä–µ–∑ `/mm-otp`)
- `MM_SCHEME` (default: `https`)
- `MM_PORT` (default: `443`)
- `MM_BASEPATH` (default: –ø—É—Å—Ç–æ) ‚Äî –µ—Å–ª–∏ Mattermost –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –ø—É—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: `/mattermost`, –±–µ–∑ `/api/v4`)
- `MM_VERIFY` (default: `1`) ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
- `MM_TIMEOUT_SECONDS` (default: `20`)
- `MM_UNREAD_MINUTES` (default: `15`) ‚Äî —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –¥–µ—Ä–∂–∞—Ç—å ¬´–Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º¬ª, –ø—Ä–µ–∂–¥–µ —á–µ–º —Å–ª–∞—Ç—å –≤ Telegram
- `MM_POLL_INTERVAL_SECONDS` (default: `WATCH_INTERVAL_SECONDS`) ‚Äî –∫–∞–∫ —á–∞—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å
- `MM_TEAM_NAMES` (optional) ‚Äî team name –∏–∑ URL (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é). –ï—Å–ª–∏ –ø—É—Å—Ç–æ –∏ `MM_CHANNEL_IDS` –Ω–µ –∑–∞–¥–∞–Ω, –±–µ—Ä—É—Ç—Å—è –≤—Å–µ teams –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- `MM_TEAM_IDS` (optional) ‚Äî —è–≤–Ω—ã–µ team_id (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
- `MM_CHANNEL_IDS` (optional) ‚Äî —è–≤–Ω—ã–µ channel_id (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é; –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç DMs). –ï—Å–ª–∏ –∑–∞–¥–∞–Ω–æ, team‚Äë—Å–∫–∞–Ω –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è.
- `MM_EXTRA_CHANNEL_IDS` (optional) ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ channel_id (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é), –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –Ω–∞–±–æ—Ä—É (–Ω–µ –æ—Ç–∫–ª—é—á–∞–µ—Ç team‚Äë—Å–∫–∞–Ω). –£–¥–æ–±–Ω–æ, –µ—Å–ª–∏ `MM_TEAM_NAMES` –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã, –Ω–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å 1‚Äì2 –∫–∞–Ω–∞–ª–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö.
- `MM_INCLUDE_DMS` (default: `1`) ‚Äî –≤–∫–ª—é—á–∞—Ç—å direct/group messages –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è, –µ—Å–ª–∏ –∑–∞–¥–∞–Ω `MM_CHANNEL_IDS`)
- `MM_CACHE_SESSION_TOKEN` (default: `1`) ‚Äî –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å session token –Ω–∞ –¥–∏—Å–∫ (`logs/tg-bot/state.json`), —á—Ç–æ–±—ã —Ä–µ–∂–µ –≤–≤–æ–¥–∏—Ç—å MFA –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤
- `MM_MAX_CHANNELS` (default: `100`) ‚Äî –º–∞–∫—Å–∏–º—É–º –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- `MM_MAX_POSTS_PER_CHANNEL` (default: `20`) ‚Äî –º–∞–∫—Å–∏–º—É–º –ø–æ—Å—Ç–æ–≤ –∑–∞ —Ç–∏–∫ –Ω–∞ –∫–∞–Ω–∞–ª
- `MM_POST_MAX_CHARS` (default: `400`) ‚Äî –æ–±—Ä–µ–∑–∫–∞ —Ç–µ–∫—Å—Ç–∞ –ø–æ—Å—Ç–∞

–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è:
- `MM_TOKEN` (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ): Mattermost ‚Üí Settings ‚Üí Security ‚Üí Personal Access Tokens ‚Üí Create Token.
- `MM_LOGIN_ID` / `MM_PASSWORD`: –æ–±—ã—á–Ω—ã–µ —É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
- 2FA/MFA: Mattermost API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç session token —á–µ—Ä–µ–∑ `POST /api/v4/users/login` (–≤ –æ—Ç–≤–µ—Ç–µ –±—É–¥–µ—Ç header `Token`). –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–∫–ª—é—á—ë–Ω MFA ‚Äî –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ –Ω—É–∂–µ–Ω –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∫–æ–¥ (–æ–±—ã—á–Ω–æ 1‚Äì2 –º–∏–Ω—É—Ç—ã, –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞ `token`). –í –±–æ—Ç–µ —ç—Ç–æ –≤–≤–æ–¥–∏—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π `/mm-otp 123456` –≤ –Ω—É–∂–Ω–æ–º —Ç–æ–ø–∏–∫–µ; session token –º–æ–∂–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –¥–∏—Å–∫ —á–µ—Ä–µ–∑ `MM_CACHE_SESSION_TOKEN=1`.
- `MM_TEAM_NAMES`: –±–µ—Ä—ë—Ç—Å—è –∏–∑ URL –≤–∏–¥–∞ `https://<host>/<team-name>/channels/...` (—ç—Ç–æ `team-name`).
- `MM_TEAM_IDS`/`MM_CHANNEL_IDS`: –º–æ–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ —á–µ—Ä–µ–∑ python (–ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –∑–∞–ø–æ–ª–Ω–∏–ª `MM_*`):

```bash
python3 - <<'PY'
import os
import urllib.parse
from mattermostdriver import Driver

raw = os.environ["MM_URL"]
u = urllib.parse.urlparse(raw if "://" in raw else "https://" + raw)
scheme = os.getenv("MM_SCHEME", u.scheme or "https")
host = u.hostname or u.path.split("/")[0]
port = int(os.getenv("MM_PORT", u.port or (443 if scheme == "https" else 80)))
basepath = os.getenv("MM_BASEPATH", u.path if u.path not in ("", "/") else "")
verify = os.getenv("MM_VERIFY", "1").strip().lower() not in ("0", "false", "no", "off")
auth_mode = os.getenv("MM_AUTH_MODE", "auto").strip().lower()
if auth_mode not in ("auto", "token", "login"):
    auth_mode = "auto"

def api_basepath(ui_path: str) -> str:
    p = (ui_path or "").rstrip("/")
    if p.endswith("/api/v4"):
        return p
    return (p + "/api/v4") if p else "/api/v4"

opts = {"url": host, "scheme": scheme, "port": port, "verify": verify, "basepath": api_basepath(basepath)}
if auth_mode == "token" or (auth_mode == "auto" and os.getenv("MM_TOKEN")):
    opts["token"] = os.environ["MM_TOKEN"]
else:
    opts["login_id"] = os.environ["MM_LOGIN_ID"]
    opts["password"] = os.environ["MM_PASSWORD"]
    mfa_token = input("MFA –∫–æ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, 6 —Ü–∏—Ñ—Ä): ").strip()
    if mfa_token:
        opts["mfa_token"] = mfa_token

d = Driver(opts)
d.login()
me = d.users.get_user("me")
uid = me["id"]
for t in d.teams.get_user_teams(uid):
    print("TEAM", (t.get("display_name") or t.get("name")), t["name"], t["id"])
    for c in d.channels.get_channels_for_user(uid, t["id"]):
        print("  CH", (c.get("display_name") or c.get("name")), c["id"], "type", c.get("type"))
PY
```

–ü—Ä–∏–≤—è–∑–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏: –∑–∞–ø—É—Å—Ç–∏ `/reminders` –≤ –Ω—É–∂–Ω–æ–º —Ç–æ–ø–∏–∫–µ ‚Äî —Ç—É–¥–∞ –∂–µ –ø–æ–π–¥—É—Ç Mattermost‚Äë—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–∏ —Ç—É–¥–∞ –∂–µ –±–æ—Ç –ø–æ–ø—Ä–æ—Å–∏—Ç MFA –∫–æ–¥, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω).

### Router
- `ROUTER_MODE` (default: `hybrid`) ‚Äî `codex` | `heuristic` | `hybrid`
- `ROUTER_MIN_PROFILE` (default: `read`) ‚Äî `read` | `write` | `danger` (alias: `TG_MIN_PROFILE`)
- `ROUTER_FORCE_WRITE_PREFIX` (default: `!`)
- `ROUTER_FORCE_READ_PREFIX` (default: `?`)
- `ROUTER_FORCE_DANGEROUS_PREFIX` (default: `‚àÜ`) ‚Äî ‚ö†Ô∏è dangerous override **–±–µ–∑ —Ä–æ—É—Ç–µ—Ä–∞**: –∑–∞–ø—É—Å–∫–∞–µ—Ç Codex —Å `--dangerously-bypass-approvals-and-sandbox --sandbox danger-full-access`
- `ROUTER_DANGEROUS_AUTO` (default: `0`) ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞–µ—Ç dangerous override, –∫–æ–≥–¥–∞ —Ä–æ—É—Ç–µ—Ä —É–≤–µ—Ä–µ–Ω, —á—Ç–æ –Ω—É–∂–Ω–∞ —Å–µ—Ç—å/–¥–æ—Å—Ç—É–ø –≤–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è; **–±–µ–∑** –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (alias: `TG_DANGEROUS_AUTO`)
- `ROUTER_CONFIDENCE_THRESHOLD` (default: `0.6`) ‚Äî –µ—Å–ª–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≥–æ–≤–æ—Ä–∏—Ç `write`, –Ω–æ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞ ‚Üí –±–æ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç `read`
- `ROUTER_DEBUG` (default: `0`) ‚Äî –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –≤ —á–∞—Ç —Å—Ç—Ä–æ–∫—É `[router] ...` –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º
- `TG_ROUTER_DEBUG` (default: `0`) ‚Äî alias –¥–ª—è `ROUTER_DEBUG` (–µ—Å–ª–∏ —É–¥–æ–±–Ω–µ–µ –¥–µ—Ä–∂–∞—Ç—å –≤—Å—ë TG –≤ –æ–¥–Ω–æ–º –ø—Ä–µ—Ñ–∏–∫—Å–µ)

### Codex bridge
- `CODEX_BIN` (default: `codex`)
  - –µ—Å–ª–∏ –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ systemd –∏ Codex —Å—Ç–æ–∏—Ç –Ω–µ –≤ PATH ‚Äî —É–∫–∞–∂–∏—Ç–µ –ø–æ–ª–Ω—ã–π –ø—É—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: `/home/linuxbrew/.linuxbrew/bin/codex`)
- `CODEX_MODEL` (optional)
- `CODEX_TIMEOUT_SECONDS` (default: 900)
- `CODEX_CHAT_SANDBOX` (default: `read-only`)
- `CODEX_AUTO_FULL_AUTO` (default: `1`)
- `CODEX_ROUTER_SANDBOX` (default: `read-only`)
- `CODEX_HOME_DANGER` (optional) ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π `CODEX_HOME` –¥–ª—è dangerous‚Äë—Å–µ—Å—Å–∏–π
- `CODEX_AUTOMATION_PATTERNS` ‚Äî legacy regex fallback (–¥–ª—è `hybrid` —Ä–µ–∂–∏–º–∞, –µ—Å–ª–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–µ —Ä–∞—Å–ø–∞—Ä—Å–∏–ª—Å—è)

### –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- `TG_BOT_STATE_PATH` (default: `logs/tg-bot/state.json`)

## –ö–æ–º–∞–Ω–¥—ã –≤ Telegram (–ª–æ–∫–∞–ª—å–Ω—ã–µ)

- `/help`
- `/status` ‚Äî –ø–æ–∫–∞–∂–µ—Ç ¬´—Å–≤–µ–∂–µ—Å—Ç—å¬ª KB/–ø–æ—Å–ª–µ–¥–Ω—é—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
- `/reminders` ‚Äî –ø–æ–∫–∞–∂–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∏ –ø—Ä–∏–≤—è–∂–µ—Ç –∏—Ö –¥–æ—Å—Ç–∞–≤–∫—É –∫ —Ç–µ–∫—É—â–µ–º—É —Ç–æ–ø–∏–∫—É
- `/mm-otp 123456` ‚Äî –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π 2FA/MFA –∫–æ–¥ –¥–ª—è Mattermost (–µ—Å–ª–∏ auth=login)
- `/mm-reset` ‚Äî —Å–±—Ä–æ—Å Mattermost state (cutoffs/auth), –ø–æ–ª–µ–∑–Ω–æ –µ—Å–ª–∏ –ø—Ä–∏–ª–µ—Ç–µ–ª —Å—Ç–∞—Ä—ã–π backlog
- `/stats` ‚Äî –º–µ—Ç—Ä–∏–∫–∏ —Ä–æ—É—Ç–µ—Ä–∞/–æ—á–µ—Ä–µ–¥–∏/Codex (latency, fallback, delivery)
- `/doctor` ‚Äî –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (Codex probe, speech2text, –æ—á–µ—Ä–µ–¥—å, outbox/jobs)
- `/queue` ‚Äî –æ—á–µ—Ä–µ–¥—å (inline UI + –ø–∞–≥–∏–Ω–∞—Ü–∏—è; owner; ‚úèÔ∏è Edit ‚Üí –ø–∞—É–∑–∞ –∏ –¥–µ–π—Å—Ç–≤–∏—è: move/delete)
- `/admin` ‚Äî –∞–¥–º–∏–Ω‚Äë–º–µ–Ω—é (inline –∫–Ω–æ–ø–∫–∏: queue/settings/doctor/stats/drop; owner)
- `/drop <queue|spool|jobs|confirms|outbox|all>` ‚Äî –æ—á–∏—Å—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏/–æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ (owner)
- `/upload <path> [--zip]` ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª/–ø–∞–ø–∫—É –≤ Telegram (–ø–∞–ø–∫–∞ –±—É–¥–µ—Ç –∑–∞–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∞; `--zip` —Ñ–æ—Ä—Å–∏—Ä—É–µ—Ç zip –¥–∞–∂–µ –¥–ª—è —Ñ–∞–π–ª–∞)
- `/ask <—Ç–µ–∫—Å—Ç>` ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –≤ Codex (–≤ –≥—Ä—É–ø–ø–∞—Ö: `/ask@BotName <—Ç–µ–∫—Å—Ç>`)
- `/lunch` ‚Äî –ø–∞—É–∑–∞ 60 –º–∏–Ω—É—Ç
- `/mute 30m` / `/mute 2h` / `/mute 1d`
- `/back` ‚Äî —Å–Ω—è—Ç—å –ø–∞—É–∑—É
- `/gentle [on|off|4h]` ‚Äî —â–∞–¥—è—â–∏–π —Ä–µ–∂–∏–º
- `/settings` ‚Äî —Ç—É–º–±–ª–µ—Ä—ã UX (delivery edit/new, ‚úÖ done notice, TTL)
- `/id` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å `chat_id`/`user_id`
- `/pause` ‚Äî –æ—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∑–∞–ø—É—Å–∫ Codex (SIGTERM)
- `/restart` ‚Äî graceful restart (–ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—á–µ—Ä–µ–¥–∏; –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ –¥–∏—Å–∫ –∏ –æ–±—Ä–∞–±–æ—Ç–∞—é—Ç—Å—è –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞)
- `/reset` ‚Äî —Å–±—Ä–æ—Å–∏—Ç—å telegram‚ÄëCodex —Å–µ—Å—Å–∏–∏ (–æ—á–∏—Å—Ç–∫–∞ `CODEX_HOME_*` + `logs/tg-bot/codex-resume-cache.json`; –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å)

–í –ª–∏—á–∫–µ –≤—Å—ë, —á—Ç–æ **–Ω–µ** –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `/`, –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –≤ Codex. –í –≥—Ä—É–ø–ø–∞—Ö ‚Äî –Ω–∞–¥—ë–∂–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `/ask@BotName ‚Ä¶` –∏–ª–∏ reply –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞ (—Å–º. Privacy Mode –≤—ã—à–µ).

## systemd (user)

–®–∞–±–ª–æ–Ω: `tg_bot/examples/systemd.service`.
